/*  
 * ######
 * ## sema3.c
 * ## ~~~~~~~
 * ## 12.02.2013: Creation T
 * ## 07.05.2018:
 * ######
 */

#include <errno.h>
#include <stdio.h>
#include <stdlib.h>
#include <sys/signal.h>
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/sem.h>
#include <unistd.h>

/* Declaration des Types et des Variables */

  extern int errno;

/* Programme principal */

int main()
{
  key_t  key = 3;

  int    semid, nsems, semnum;
  int    kr, val;

  int    b_EXISTS = 0;

/* Attachement Ensemble( 3 ) qui est constitue de 1 semaphore */
  
  printf( " sema3> \n");
  printf( " sema3> Tentative Ouverture Ensemble SEMAPHORES( 3 ) avec IPC_EXCL\n");
  printf( " sema3> \n");

  nsems = 1;

  semid = semget( key, nsems, 0640 | IPC_CREAT | IPC_EXCL );

  if ( semid == -1 ) {
    if ( errno == EEXIST ) {

      b_EXISTS = 1;

      printf( " sema3> Ensemble de SEMAPHORES( 3 ) existant \n");
      printf( " sema3> \n");

      /* Re-ouverture sans IPC_EXCL */

      semid = semget( key, nsems, 0640 | IPC_CREAT );

      /* Affichage de la valeur associee au semaphore numero 0 */

      semnum = 0;
    
      val = semctl( semid, semnum, GETVAL, NULL );

      if ( val == -1 ) {

        perror( " sema3> Pb. recuperation valeur semaphore" );

      } else {

        printf( " sema3> Valeur du semaphore zero = %d\n", val );
      }

      printf( " sema3> \n");

    } else {

      perror( " sema3> Pb. Ouverture Ensemble SEMAPHORES( 3 )" ); exit( 1 );
      printf( " sema3> \n");
    }

  } else {

    printf( " sema3> Ensemble SEMAPHORES( 3 ) inexistant\n" );
    printf( " sema3> \n");
  }

/* Destruction de l'ensemble de semaphores ( 3 ) */

  semnum = 0;

  kr = semctl(semid, semnum, IPC_RMID, NULL);

  if ( kr == -1 ) {
    perror( " sema3> Pb. destruction semaphore\n" ); exit( 2 );
    printf( " sema3> \n");

  } else if ( b_EXISTS ) {

    /* Affichage du message seulment si il existait avant */ 

    printf( " sema3> Destruction SEMAPHORE(3)\n" );
    printf( " sema3> \n");
  }
}
/* --- fin  sema3.c  --- */

